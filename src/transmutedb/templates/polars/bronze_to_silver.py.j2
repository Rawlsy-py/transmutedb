import polars as pl
from transmutedb.transforms.polars_ops import coerce_types{% if model.scd2 %}, scd2_merge{% endif %}
from transmutedb.connectors.duck import write_table

# NOTE: in real code, this comes from a connector by kind; we inline simple demo:
df = pl.from_dicts({{ rows | tojson }})

df = coerce_types(df, {{ type_map | tojson }})
{% if model.scd2 %}
current = pl.DataFrame()
df = scd2_merge(df, current,
    {{ model.scd2.business_key | tojson }},
    {{ model.scd2.hashdiff_cols | tojson }})
{% endif %}

write_table(df, path="{{ target.path }}", schema="{{ target.schema }}", table="{{ model.name }}")
